---
title: "SaaS Tool Authentication"
description: "Authentication methods and flows for connecting to third-party SaaS tools"
---

## Overview

**SaaS Tool Authentication** is the process of securely connecting third-party services (like Salesforce, Slack, Pipedrive) to the Kambrium platform. Each SaaS tool connection requires proper authentication to ensure secure data access through the Management API.

<Info>
**Two Authentication Methods:** SaaS tools support either **API Key** authentication or **OAuth 2.1** flows depending on the service capabilities and security requirements.

**Schema Validation:** The Management API enforces strict validation through Pydantic schema validation - `api_key` and `auth_method: "oauth"` cannot be used together (422 error).

</Info>

---

## Authentication Methods

Kambrium supports two primary methods for authenticating with SaaS tools:

<CardGroup cols={2}>
  <Card title="API Key Authentication" icon="key">
    **Best for:** Services with API key support, development environments
    **Default:** When `auth_method` is not specified, defaults to `"api_key"`
    **Process:** Direct API key storage with immediate verification
    **Schema:** Requires `api_key` field when `auth_method: "api_key"`, rejects `api_key` when `auth_method: "oauth"`
  </Card>

  <Card title="OAuth 2.1 Flows" icon="shield-check">
    **Best for:** Production environments, enhanced security
    **Process:** External OAuth flows via `SaaSOAuthProvider` model
    **Security:** PKCE-enabled authorization with token refresh (where supported)
    **Schema:** Requires `auth_method: "oauth"`, rejects `api_key` field (422 validation error)
  </Card>
</CardGroup>

---

## API Key Authentication

### Default Authentication Method

API key authentication is the default when no `auth_method` is specified:

<CodeGroup>
```http Default API Key Connection
POST /api/v1/mcp-servers
Authorization: Bearer <management_token>
Content-Type: application/json

{
"mcp_server": "pipedrive",
"access_type": "write",
"api_key": "user-provided-api-key-from-pipedrive"
// auth_method defaults to "api_key"
}

````

```http Explicit API Key Connection
POST /api/v1/mcp-servers
Authorization: Bearer <management_token>
Content-Type: application/json

{
  "mcp_server": "pipedrive",
  "access_type": "write",
  "auth_method": "api_key",
  "api_key": "user-provided-api-key-from-pipedrive"
}
````

</CodeGroup>

### API Key Connection Response

```json
{
  "success": true,
  "data": {
    "id": 445,
    "mcp_server": "pipedrive",
    "access_type": "write",
    "api_key_verification_status": "pending",
    "oauth2_client_id": "2f6ictccuujm5vj4dnen5kmf8q",
    "oauth2_client_secret": "generated_for_mcp_access",
    "mcp_server_access_status": "active",
    "agent_enabled": true
  }
}
```

### Schema Validation

The Management API enforces strict schema validation for API key connections:

<AccordionGroup>
  <Accordion title="Valid API Key Schema" icon="check">
    **Required Fields:**
    - `mcp_server`: Target SaaS service name
    - `access_type`: Permission level (`"read"`, `"write"`, `"individual"`)
    - `api_key`: User's API key from SaaS provider
    
    **Optional Fields:**
    - `auth_method`: Defaults to `"api_key"` if not specified
  </Accordion>

  <Accordion title="Invalid Schema Examples" icon="x">
    **Missing API Key:**
    ```json
    {
      "mcp_server": "pipedrive",
      "access_type": "write",
      "auth_method": "api_key"
      // Missing required api_key field - Returns 422 validation error
    }
    ```
    
    **OAuth + API Key Conflict:**
    ```json
    {
      "mcp_server": "pipedrive",
      "access_type": "write",
      "auth_method": "oauth",
      "api_key": "should-not-be-provided"
      // Invalid combination - Returns 422 validation error
    }
    ```
  </Accordion>
</AccordionGroup>

---

## OAuth 2.1 Authentication

### External OAuth Flow

OAuth authentication uses `SaaSOAuthProvider` configurations for third-party OAuth flows:

<CodeGroup>
```http OAuth Connection Request
POST /api/v1/mcp-servers
Authorization: Bearer <management_token>
Content-Type: application/json

{
"mcp_server": "pipedrive",
"access_type": "write",
"auth_method": "oauth"
// No api_key field allowed with OAuth
}

````

```json OAuth Authorization Response
{
  "success": true,
  "data": {
    "auth_method": "oauth",
    "authorization_url": "https://oauth.pipedrive.com/oauth/authorize?client_id=5e70f6f8dbb83c2f&redirect_uri=...",
    "oauth_status": "pending",
    "message": "User authorization required. Visit the authorization URL to complete OAuth flow."
  }
}
````

</CodeGroup>

### OAuth Provider Configuration

OAuth providers are configured in the `SaaSOAuthProvider` model:

```json
{
  "name": "pipedrive",
  "display_name": "Pipedrive",
  "authorization_endpoint": "https://oauth.pipedrive.com/oauth/authorize",
  "token_endpoint": "https://oauth.pipedrive.com/oauth/token",
  "client_id": "5e70f6f8dbb83c2f",
  "client_secret_encrypted": "encrypted_secret",
  "scopes": ["base"],
  "requires_pkce": false,
  "supports_refresh": true
}
```

### OAuth Flow Steps

<Tabs>
  <Tab title="Step 1: Authorization">
    **User Authorization Required**
    
    ```http
    GET https://oauth.pipedrive.com/oauth/authorize
      ?client_id=5e70f6f8dbb83c2f
      &redirect_uri=https://your-domain.com/oauth/callback
      &response_type=code
      &scope=base
      &state=encrypted_state_parameter
    ```
  </Tab>

{" "}

<Tab title="Step 2: Callback">
  **OAuth Callback Processing** ```http POST
  /api/mcp-servers/saas-oauth/pipedrive/callback/ Content-Type:
  application/x-www-form-urlencoded
  code=auth_code_from_provider&state=encrypted_state_parameter&scope=base ```
</Tab>

  <Tab title="Step 3: Token Exchange">
    **Backend Token Exchange**
    
    ```http
    POST https://oauth.pipedrive.com/oauth/token
    Content-Type: application/x-www-form-urlencoded
    
    grant_type=authorization_code
    &code=auth_code_from_provider
    &client_id=5e70f6f8dbb83c2f
    &client_secret=provider_client_secret
    &redirect_uri=callback_uri
    ```
  </Tab>
</Tabs>

---

## Database Storage Models

### API Key Storage

API key connections store credentials in the `mcp_server_access` table:

```python
# API Key Authentication
api_key = "user_provided_api_key"  # Direct storage
saas_oauth_provider = None  # No OAuth provider
saas_access_token_encrypted = None  # No OAuth tokens
saas_refresh_token_encrypted = None
```

### OAuth Storage

OAuth connections store tokens in encrypted fields:

```python
# OAuth Authentication
api_key = None  # No direct API key
saas_oauth_provider_id = 1  # Links to SaaSOAuthProvider
saas_access_token_encrypted = "encrypted_oauth_access_token"
saas_refresh_token_encrypted = "encrypted_oauth_refresh_token"
saas_token_expires_at = datetime(2024, 2, 15, 10, 0, 0)
saas_oauth_scopes = ["base"]
```

### Authentication Method Detection

The system determines authentication method using model properties:

```python
@property
def saas_authentication_method(self):
    """Return the SaaS authentication method used"""
    if self.saas_oauth_provider:
        return 'oauth2'
    elif self.api_key:
        return 'api_key'
    else:
        return None

@property
def has_saas_oauth(self):
    """Check if this access has SaaS OAuth configured"""
    return bool(self.saas_oauth_provider and self.saas_access_token_encrypted)
```

---

## Error Handling

### Schema Validation Errors

<AccordionGroup>
  <Accordion title="422 Missing API Key" icon="alert-triangle">
    **API Key Required with auth_method: "api_key"**
    
    Based on test implementation: HTTP 422 error when `auth_method: "api_key"` is specified without providing `api_key` field.
    
    ```json
    {
      "detail": [
        {
          "type": "missing",
          "loc": ["body", "api_key"],
          "msg": "Field required when auth_method is api_key",
          "input": {
            "mcp_server": "pipedrive",
            "access_type": "write",
            "auth_method": "api_key"
          }
        }
      ]
    }
    ```
  </Accordion>

  <Accordion title="422 OAuth + API Key Conflict" icon="x">
    **api_key field not allowed with auth_method: "oauth"**
    
    Based on test implementation: HTTP 422 error when both `auth_method: "oauth"` and `api_key` are provided.
    
    ```json
    {
      "detail": [
        {
          "type": "value_error", 
          "loc": ["body"],
          "msg": "Validation error: api_key and oauth method conflict",
          "input": {
            "mcp_server": "pipedrive",
            "access_type": "write", 
            "auth_method": "oauth",
            "api_key": "should-not-be-provided"
          }
        }
      ]
    }
    ```
  </Accordion>

  <Accordion title="OAuth Flow Errors" icon="shield-x">
    **OAuth State Validation Failed**
    ```json
    {
      "success": false,
      "error": "Invalid state parameter",
      "message": "OAuth state validation failed. Possible CSRF attack."
    }
    ```
  </Accordion>
</AccordionGroup>

---

## Security Implementation

### API Key Security

- **Secure Storage:** API keys stored in encrypted database fields
- **Verification:** Background verification of API key validity
- **Rate Limiting:** API key usage monitored for abuse detection
- **Audit Logging:** All API key operations logged for security

### OAuth Security Features

- **State Validation:** HMAC-signed state parameters prevent CSRF attacks
- **PKCE Support:** Code challenge/verifier for enhanced security (where supported)
- **Token Encryption:** OAuth tokens encrypted at rest using AES-256
- **Refresh Handling:** Automatic token refresh with secure rotation

### Provider-Specific Security

<Tabs>
  <Tab title="Pipedrive">
    **OAuth Configuration:**
    - Authorization: `https://oauth.pipedrive.com/oauth/authorize`
    - Token Endpoint: `https://oauth.pipedrive.com/oauth/token`
    - PKCE: Not required
    - Refresh: Supported
    - Scopes: `["base"]`
  </Tab>

  <Tab title="Gmail">
    **OAuth Configuration:**
    - Authorization: `https://accounts.google.com/o/oauth2/v2/auth`
    - Token Endpoint: `https://oauth2.googleapis.com/token`
    - PKCE: Required
    - Refresh: Supported
    - Scopes: `["https://www.googleapis.com/auth/gmail.readonly"]`
  </Tab>
</Tabs>

---

## Integration Examples

### Creating API Key Connection

<CodeGroup>
```python Python API Key Example
import httpx

async def create_api_key_connection(management_token: str, api_key: str):
headers = {
"Authorization": f"Bearer {management_token}",
"Content-Type": "application/json"
}

    data = {
        "mcp_server": "pipedrive",
        "access_type": "write",
        "api_key": api_key
        # auth_method defaults to "api_key"
    }

    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://your-domain.com/api/v1/mcp-servers",
            headers=headers,
            json=data
        )
        return response.json()

````

```javascript JavaScript OAuth Example
async function createOAuthConnection(managementToken) {
  const response = await fetch('https://your-domain.com/api/v1/mcp-servers', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${managementToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      mcp_server: 'pipedrive',
      access_type: 'write',
      auth_method: 'oauth'
      // No api_key field with OAuth
    })
  });

  const result = await response.json();

  if (result.success) {
    // Redirect user to authorization URL
    window.location.href = result.data.authorization_url;
  }

  return result;
}
````

</CodeGroup>

---

## Best Practices

### API Key Management

- **Source Verification:** Only accept API keys directly from users
- **Immediate Validation:** Verify API keys against SaaS provider APIs
- **Secure Storage:** Never log or expose API keys in responses
- **Regular Rotation:** Encourage users to rotate API keys regularly

### OAuth Implementation

- **State Security:** Always use HMAC-signed state parameters
- **HTTPS Only:** OAuth flows must use HTTPS for all redirects
- **Token Lifecycle:** Implement proper token refresh and expiration handling
- **Error Recovery:** Handle OAuth failures gracefully with clear user messaging

---

## Next Steps

<CardGroup cols={2}>
  <Card title="Management API" href="/authentication/management-api" icon="cog">
    Learn about Management API authentication for server lifecycle
  </Card>

{" "}

<Card title="MCP Server Access" href="/authentication/mcp-server" icon="server">
  Understand MCP server runtime authentication
</Card>

{" "}

<Card title="Complete Tutorial" href="/guides/mcp-setup" icon="rocket">
  End-to-end setup walkthrough
</Card>

  <Card title="API Reference" href="/api-reference/introduction" icon="book">
    Explore the complete API documentation
  </Card>
</CardGroup>

<Note>
  SaaS tool authentication ensures secure, standards-compliant connections to
  third-party services using either API keys or OAuth 2.1 flows.
</Note>
